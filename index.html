<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro TV Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: black; overflow: hidden; }
        #safe-zone { width: 100vw; height: 100vh; display: block; }
    </style>
</head>
<body>

    <div id="safe-zone"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const videoUrl = urlParams.get('url');

        // SHADOW DOM LÉTREHOZÁSA
        const host = document.getElementById('safe-zone');
        const shadow = host.attachShadow({ mode: 'closed' });

        // STÍLUSOK
        const style = document.createElement('style');
        style.textContent = `
            @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');
            :host { display: block; width: 100%; height: 100%; position: relative; font-family: sans-serif; }
            video { width: 100%; height: 100%; object-fit: contain; background: black; }
            video::-webkit-media-controls { display: none !important; }

            /* Visszajelző ikonok középen */
            .center-feedback {
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                font-size: 80px; color: rgba(255,255,255,0.9);
                background: rgba(0,0,0,0.6); padding: 20px 40px; border-radius: 20px;
                pointer-events: none; z-index: 20; display: none; flex-direction: column; align-items: center;
            }
            .center-text { font-size: 30px; margin-top: 10px; color: #fff; }

            /* Vezérlősáv */
            .controls {
                position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
                background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
                display: flex; align-items: center; padding: 0 30px; z-index: 30; transition: opacity 0.3s;
            }
            
            button { background: none; border: none; color: white; font-size: 24px; width: 45px; cursor: pointer; }
            .time { color: white; font-size: 18px; margin: 0 15px; min-width: 110px; text-align: center; }
            
            /* Csúszkák */
            .slider-container { position: relative; display: flex; align-items: center; }
            .seek-box { flex-grow: 1; margin: 0 15px; }
            .vol-box { width: 100px; margin-left: 5px; display: flex; align-items: center; }
            
            input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: #555; border-radius: 5px; outline: none; }
            input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: red; border-radius: 50%; border: 2px solid white; }

            /* MINŐSÉG MENÜ */
            .quality-container { position: relative; margin-left: 10px; }
            .quality-menu {
                position: absolute; bottom: 60px; right: 0;
                background: rgba(0,0,0,0.9); border: 1px solid #444; border-radius: 5px;
                padding: 5px 0; display: none; flex-direction: column; min-width: 120px;
            }
            .quality-item {
                color: white; padding: 10px 20px; cursor: pointer; text-align: left; font-size: 16px;
            }
            .quality-item:hover, .quality-item.active { background: red; }
            
            .hidden { opacity: 0; }
        `;
        shadow.appendChild(style);

        // HTML FELÉPÍTÉS
        const container = document.createElement('div');
        container.style.width = '100%'; container.style.height = '100%'; container.style.position = 'relative';

        container.innerHTML = `
            <div id="feedback" class="center-feedback">
                <i id="fb-icon" class="fas fa-play"></i>
                <span id="fb-text" class="center-text"></span>
            </div>
            
            <video id="v" playsinline webkit-playsinline></video>

            <div id="controls" class="controls">
                <button id="btn-play"><i class="fas fa-play"></i></button>
                
                <div class="vol-box">
                    <button id="btn-mute"><i class="fas fa-volume-up"></i></button>
                    <input type="range" id="vol-slider" min="0" max="1" step="0.1" value="1">
                </div>

                <div class="time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
                
                <div class="slider-container seek-box">
                    <input type="range" id="seek" min="0" value="0" step="1">
                </div>

                <div class="quality-container" id="quality-wrapper" style="display:none;">
                    <button id="btn-settings"><i class="fas fa-cog"></i></button>
                    <div id="quality-menu" class="quality-menu"></div>
                </div>
            </div>
        `;
        shadow.appendChild(container);

        // JAVASCRIPT
        const vid = container.querySelector('#v');
        const feedback = container.querySelector('#feedback');
        const fbIcon = container.querySelector('#fb-icon');
        const fbText = container.querySelector('#fb-text');
        const btnPlay = container.querySelector('#btn-play');
        const btnMute = container.querySelector('#btn-mute');
        const seek = container.querySelector('#seek');
        const volSlider = container.querySelector('#vol-slider');
        const curText = container.querySelector('#cur');
        const durText = container.querySelector('#dur');
        const controlsDiv = container.querySelector('#controls');
        
        // Minőség elemek
        const qualityWrapper = container.querySelector('#quality-wrapper');
        const btnSettings = container.querySelector('#btn-settings');
        const qualityMenu = container.querySelector('#quality-menu');

        let hlsInstance = null;

        // BETÖLTÉS
        if (videoUrl) {
            if (Hls.isSupported() && videoUrl.includes('.m3u8')) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(videoUrl);
                hlsInstance.attachMedia(vid);
                
                // Amikor betöltődtek a minőségek (Levels)
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                    if (data.levels.length > 1) {
                        setupQualityMenu(data.levels);
                        qualityWrapper.style.display = 'block'; // Csak akkor mutatjuk, ha van választék
                    }
                });
            } else {
                vid.src = videoUrl;
                // MP4-nél nincs minőség választás
            }
        } else {
            showFeedback('fa-exclamation', 'Nincs URL');
        }

        // --- MINŐSÉG MENÜ LOGIKA ---
        function setupQualityMenu(levels) {
            qualityMenu.innerHTML = '';
            
            // Auto opció
            createQualityItem('Auto', -1, true);

            // Többi felbontás (fordított sorrendben, hogy a legnagyobb legyen felül)
            levels.forEach((level, index) => {
                const label = level.height ? level.height + 'p' : 'Level ' + index;
                createQualityItem(label, index, false);
            }).reverse(); // Ha a lista nem sorrendben jönne
        }

        function createQualityItem(text, levelIndex, isAuto) {
            const div = document.createElement('div');
            div.className = 'quality-item';
            div.innerText = text;
            if (isAuto) div.classList.add('active');

            div.onclick = () => {
                hlsInstance.currentLevel = levelIndex; // -1 = Auto, 0,1,2... = Fix minőség
                
                // Aktív osztály áthelyezése
                container.querySelectorAll('.quality-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
                
                qualityMenu.style.display = 'none'; // Menü bezárása
                showFeedback('fa-check', text);
            };
            
            // Hozzáadjuk a menühöz (de ha nem Auto, akkor fordított sorrend miatt az elejére szúrjuk be, kivéve ha rendezni akarjuk)
            // Egyszerűsítve: simán hozzáadjuk
            qualityMenu.appendChild(div);
        }

        btnSettings.onclick = () => {
            const currentDisplay = qualityMenu.style.display;
            qualityMenu.style.display = currentDisplay === 'flex' ? 'none' : 'flex';
        };

        // --- VIZUÁLIS VISSZAJELZÉS ---
        let fbTimer;
        function showFeedback(iconClass, text = '') {
            fbIcon.className = `fas ${iconClass}`;
            fbText.innerText = text;
            feedback.style.display = 'flex';
            clearTimeout(fbTimer);
            fbTimer = setTimeout(() => { feedback.style.display = 'none'; }, 1000);
        }

        // --- LEJÁTSZÁS ---
        function togglePlay() {
            if (vid.paused) {
                vid.play(); showFeedback('fa-play'); btnPlay.innerHTML = '<i class="fas fa-pause"></i>'; resetTimer();
            } else {
                vid.pause(); showFeedback('fa-pause'); btnPlay.innerHTML = '<i class="fas fa-play"></i>'; controlsDiv.classList.remove('hidden');
            }
        }

        // --- EGYÉB FUNKCIÓK (Tekerés, Hangerő) ---
        function seekVideo(seconds) {
            vid.currentTime = Math.max(0, Math.min(vid.duration, vid.currentTime + seconds));
            const icon = seconds > 0 ? 'fa-forward' : 'fa-backward';
            showFeedback(icon, (seconds>0?'+':'') + seconds + 's');
            resetTimer();
        }

        function changeVolume(change) {
            let newVol = vid.volume + change;
            if (newVol > 1) newVol = 1; if (newVol < 0) newVol = 0;
            vid.volume = newVol; volSlider.value = newVol;
            updateVolIcon(); resetTimer();
            showFeedback(newVol===0?'fa-volume-mute':'fa-volume-up', Math.round(newVol*100)+'%');
        }
        
        function updateVolIcon() {
            if(vid.volume===0) btnMute.innerHTML='<i class="fas fa-volume-mute"></i>';
            else if(vid.volume<0.5) btnMute.innerHTML='<i class="fas fa-volume-down"></i>';
            else btnMute.innerHTML='<i class="fas fa-volume-up"></i>';
        }

        // --- ESEMÉNYKEZELŐK ---
        btnPlay.onclick = togglePlay;
        vid.onclick = togglePlay;
        
        // Távirányító
        document.addEventListener('keydown', (e) => {
            const code = e.keyCode;
            if (code === 13 || code === 32) { togglePlay(); e.preventDefault(); } // OK/Space
            if (code === 39) { seekVideo(10); e.preventDefault(); } // Jobb
            if (code === 37) { seekVideo(-10); e.preventDefault(); } // Bal
            if (code === 38) { changeVolume(0.1); e.preventDefault(); } // Fel
            if (code === 40) { changeVolume(-0.1); e.preventDefault(); } // Le
        });

        seek.oninput = () => vid.currentTime = seek.value;
        volSlider.oninput = () => { vid.volume = volSlider.value; updateVolIcon(); };

        // Idő
        function formatTime(s) { const m=Math.floor(s/60); const sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }
        vid.addEventListener('timeupdate', () => {
            if (!isNaN(vid.duration)) { seek.max = vid.duration; durText.innerText = formatTime(vid.duration); }
            seek.value = vid.currentTime; curText.innerText = formatTime(vid.currentTime);
        });

        // Auto-hide
        let timer;
        function resetTimer() {
            controlsDiv.classList.remove('hidden');
            clearTimeout(timer);
            timer = setTimeout(() => { if (!vid.paused) controlsDiv.classList.add('hidden'); }, 4000);
        }
        container.addEventListener('mousemove', resetTimer);
        container.addEventListener('click', resetTimer);

    </script>
</body>
</html>
